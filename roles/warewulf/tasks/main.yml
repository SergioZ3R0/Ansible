---
# tasks file for warewulf
#GENERAL
- name: "Instalar paquetes con dnf"
  dnf:
    name: "{{ item }}"
    state: present
  loop: "{{ dnf_packages }}"
  when: ansible_os_family == "RedHat" and install_dnf == true
  ignore_errors: yes
#---------------------------------------------------------------
- name: "Include monitoring role"
  include_role:
    name: monitoring
  when: monitoring_warewulf == true
#---------------------------------------------------------------
#Used on headNodeComplete.yml
- name: "Modify /etc/hosts"
  template:
    src: ../confFiles/hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: '0644'
  when: make_hosts == true
#------------------------------------------------------------------
#Used on warewulfInstall.yml
- name: Edit the overlay with the template
  shell: |
    wwctl overlay edit host /etc/hosts.ww << 'EOF'
    {{ IncludeBlock "/etc/hosts" "# Do not edit after this line" }}
    # This block is autogenerated by warewulf
    # Host:   {{.BuildHost}}
    # Time:   {{.BuildTime}}
    # Source: {{.BuildSource}}

    # Warewulf Server
    {{$.Ipaddr}} warewulf {{$.BuildHost}} {{$.BuildHost}}.<CUSTOMER-DOMAIN>

    {{- range $node := $.AllNodes}}                  {{/* for each node */}}
    # Entry for {{$node.Id.Get}}:
    {{/* if we have IPMI address on the node */}}
    {{- if $node.Ipmi.Ipaddr.Defined}}{{$node.Ipmi.Ipaddr.Get}} {{$node.Id.Get}}-ipmi {{$node.Id.Get}}-bmc{{end}}
    {{- range $devname, $netdev := $node.NetDevs}}   {{/* for each network device on the node */}}
    {{- if $netdev.Ipaddr.Defined}}                  {{/* if we have an ip address on this network device */}}
    {{$netdev.Ipaddr.Get}} {{$node.Id.Get}}-{{$devname}}
    {{- if $netdev.Device.Defined}} {{$node.Id.Get}}-{{$netdev.Device.Get}}{{end}}
    {{- if $netdev.Primary.GetB}} {{$node.Id.Get}}{{end}}
    {{- end}} {{/* end if ip */}}
    {{- end}} {{/* end for each network device */}}
    {{- end}} {{/* end for each node */}}
    EOF
  notify: restart warewulf
  when: update_overlay == true
  #------------------------------------------------------------------------------------
