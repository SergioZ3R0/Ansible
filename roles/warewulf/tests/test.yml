---
- name: Aplicar rol de instalaci√≥n de software
  hosts: rocky
  become: yes
  roles:
    - role: warewulf
  vars:
  dnf_packages: ""{{ basic_packages }}""
  services:
    - name : 'lldpd'
      enabled: true
  make_hosts: false

- name: Enable powertools repository
  command: dnf config-manager --set-enabled powertools
  when: ansible_os_family == "RedHat"

- name: Install EPEL release
  command: dnf install -y epel-release
  when: ansible_os_family == "RedHat"

- name: Enable and start lldpd service
  systemd:
    name: lldpd
    enabled: yes
    state: started
  when: ansible_os_family == "RedHat"

- name: Generate RSA key pair
  ansible.builtin.openssh_keypair:
    path: /home/{{ ansible_user }}/.ssh/id_rsa
    type: rsa
    size: 4096
  become: false
  delegate_to: localhost

- name: Stop firewalld service
  systemd:
    name: firewalld
    state: stopped

- name: Disable firewalld service
  systemd:
    name: firewalld
    enabled: no

- name: Flush all iptables rules
  command: iptables -F

- name: Flush all iptables NAT rules
  command: iptables -t nat -F

- name: Aplicar rol firewalld
  hosts: rocky
  become: yes
  roles:
    - role: firewalld
  vars:
    firewall_rules:
      - table: nat
        chain: POSTROUTING
        rule: "-o <external-if> -j MASQUERADE"
      - table: filter
        chain: FORWARD
        rule: "-i <internal-if> -o <external-if> -j ACCEPT"
      - table: filter
        chain: FORWARD
        rule: "-i <internal-if> -o <external-if> -m state --state RELATED,ESTABLISHED -j ACCEPT"



